<div class="container-fluid p-4">
  <div class="flex align-items-center justify-content-between mb-4">
    <h1 class="text-3xl font-bold text-900 m-0">
      <i class="pi pi-cog mr-3"></i>Kereskedési Beállítások
    </h1>
  </div>

  <p-tabView>
    <!-- Position Size Tab -->
    <p-tabPanel header="Pozíció Méret" leftIcon="pi pi-dollar">
      <p-card header="Pozíció Méret Beállítások" styleClass="mb-4">
        <div class="grid">
          <div class="col-12">
            <div class="field">
              <label class="text-lg font-semibold mb-3 block">Pozíció Méret Módja</label>
              
              <div class="flex flex-column gap-3">
                <div class="flex align-items-center">
                  <p-radioButton 
                    name="mode" 
                    value="percentage" 
                    [(ngModel)]="positionSizeConfig.mode"
                    inputId="percentage"
                    (onChange)="onPositionModeChange()">
                  </p-radioButton>
                  <label for="percentage" class="ml-2 cursor-pointer">
                    <strong>Százalékos</strong> - A portfólió százaléka alapján
                  </label>
                </div>
                
                <div class="flex align-items-center">
                  <p-radioButton 
                    name="mode" 
                    value="fixed_usd" 
                    [(ngModel)]="positionSizeConfig.mode"
                    inputId="fixed_usd"
                    (onChange)="onPositionModeChange()">
                  </p-radioButton>
                  <label for="fixed_usd" class="ml-2 cursor-pointer">
                    <strong>Fix USD összeg</strong> - Minden kereskedéshez ugyanaz az összeg
                  </label>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12">
            <p-divider></p-divider>
          </div>

          <!-- Percentage Mode Settings -->
          <div class="col-12" *ngIf="positionSizeConfig.mode === 'percentage'">
            <div class="field">
              <label for="maxPercentage" class="block text-900 font-medium mb-2">
                Maximum Százalék (%)
              </label>
              <p-inputNumber
                id="maxPercentage"
                [(ngModel)]="positionSizeConfig.max_percentage"
                [min]="0.1"
                [max]="10"
                [step]="0.1"
                suffix="%"
                placeholder="pl. 2.5"
                styleClass="w-full">
              </p-inputNumber>
              <small class="text-600">
                Minden kereskedés maximum ennyi százalékot használ a teljes portfólióból (0.1% - 10%)
              </small>
            </div>

            <div class="bg-blue-50 border-left-3 border-blue-500 p-3 mt-3" *ngIf="positionSizeConfig.max_percentage && walletBalance">
              <div class="text-blue-900">
                <i class="pi pi-info-circle mr-2"></i>
                <strong>Példa számítás:</strong>
              </div>
              <div class="text-blue-800 mt-2">
                Jelenlegi portfólió: <strong>${{ walletBalance | number:'1.2-2' }}</strong><br>
                {{ positionSizeConfig.max_percentage }}% = <strong>${{ calculateExampleAmount() | number:'1.2-2' }}</strong> per kereskedés
              </div>
            </div>
          </div>

          <!-- Fixed USD Mode Settings -->
          <div class="col-12" *ngIf="positionSizeConfig.mode === 'fixed_usd'">
            <div class="field">
              <label for="fixedAmount" class="block text-900 font-medium mb-2">
                Fix USD Összeg
              </label>
              <p-inputNumber
                id="fixedAmount"
                [(ngModel)]="positionSizeConfig.fixed_amount_usd"
                [min]="1"
                [max]="10000"
                [step]="1"
                prefix="$"
                placeholder="pl. 100"
                styleClass="w-full">
              </p-inputNumber>
              <small class="text-600">
                Minden kereskedés pontosan ezt az összeget használja ($1 - $10,000)
              </small>
            </div>

            <div class="bg-orange-50 border-left-3 border-orange-500 p-3 mt-3" *ngIf="positionSizeConfig.fixed_amount_usd && walletBalance">
              <div class="text-orange-900">
                <i class="pi pi-exclamation-triangle mr-2"></i>
                <strong>Figyelem:</strong>
              </div>
              <div class="text-orange-800 mt-2">
                Fix összeg: <strong>${{ positionSizeConfig.fixed_amount_usd }}</strong><br>
                Ez a portfólió <strong>{{ (positionSizeConfig.fixed_amount_usd / walletBalance * 100) | number:'1.1-1' }}%-a</strong>
                <span *ngIf="(positionSizeConfig.fixed_amount_usd / walletBalance * 100) > 5" class="text-red-600">
                  <br><i class="pi pi-exclamation-triangle"></i> Magas kockázat! (>5%)
                </span>
              </div>
            </div>
          </div>

          <div class="col-12">
            <p-divider></p-divider>
          </div>

          <div class="col-12">
            <div class="flex justify-content-end">
              <p-button 
                label="Mentés" 
                icon="pi pi-save" 
                [loading]="savingPosition"
                [disabled]="!isPositionConfigValid()"
                (onClick)="savePositionSizeConfig()">
              </p-button>
            </div>
          </div>
        </div>
      </p-card>
    </p-tabPanel>

    <!-- Risk Management Tab -->
    <p-tabPanel header="Kockázatkezelés" leftIcon="pi pi-shield">
      <p-card header="Kockázatkezelési Beállítások" styleClass="mb-4">
        <div class="grid">
          <!-- Daily Trade Limit -->
          <div class="col-12 md:col-6">
            <div class="field">
              <label for="maxDailyTrades" class="block text-900 font-medium mb-2">
                <i class="pi pi-calendar mr-2"></i>Napi Trade Limit
              </label>
              <p-inputNumber
                id="maxDailyTrades"
                [(ngModel)]="riskConfig.max_daily_trades"
                [min]="1"
                [max]="100"
                [step]="1"
                placeholder="10"
                styleClass="w-full">
              </p-inputNumber>
              <small class="text-600">
                Maximum kereskedések száma naponta (1-100)
              </small>
            </div>
          </div>

          <!-- Daily Loss Limit -->
          <div class="col-12 md:col-6">
            <div class="field">
              <label for="dailyLossLimit" class="block text-900 font-medium mb-2">
                <i class="pi pi-exclamation-triangle mr-2"></i>Napi Veszteség Limit
              </label>
              <p-inputNumber
                id="dailyLossLimit"
                [(ngModel)]="riskConfig.daily_loss_limit"
                [min]="0.1"
                [max]="50"
                [step]="0.1"
                suffix="%"
                placeholder="5.0"
                styleClass="w-full">
              </p-inputNumber>
              <small class="text-600">
                Maximum napi veszteség a portfólió százalékában (0.1%-50%)
              </small>
            </div>

            <div class="bg-red-50 border-left-3 border-red-500 p-3 mt-3" *ngIf="riskConfig.daily_loss_limit && walletBalance">
              <div class="text-red-900">
                <i class="pi pi-exclamation-triangle mr-2"></i>
                <strong>Napi veszteség limit:</strong>
              </div>
              <div class="text-red-800 mt-2">
                {{ riskConfig.daily_loss_limit }}% = <strong>${{ calculateDailyLossAmount() | number:'1.2-2' }}</strong>
                <br><small>Ha eléred ezt az összeget, az auto-trading leáll</small>
              </div>
            </div>
          </div>

          <!-- Max Position Size -->
          <div class="col-12 md:col-6">
            <div class="field">
              <label for="maxPositionSize" class="block text-900 font-medium mb-2">
                <i class="pi pi-chart-pie mr-2"></i>Maximum Pozíció Méret
              </label>
              <p-inputNumber
                id="maxPositionSize"
                [(ngModel)]="riskConfig.max_position_size"
                [min]="0.1"
                [max]="20"
                [step]="0.1"
                suffix="%"
                placeholder="2.0"
                styleClass="w-full">
              </p-inputNumber>
              <small class="text-600">
                Maximum pozíció méret a portfólió százalékában (0.1%-20%)
              </small>
            </div>

            <div class="bg-yellow-50 border-left-3 border-yellow-500 p-3 mt-3" *ngIf="riskConfig.max_position_size && walletBalance">
              <div class="text-yellow-900">
                <i class="pi pi-info-circle mr-2"></i>
                <strong>Maximum pozíció:</strong>
              </div>
              <div class="text-yellow-800 mt-2">
                {{ riskConfig.max_position_size }}% = <strong>${{ calculateMaxPositionAmount() | number:'1.2-2' }}</strong> per kereskedés
              </div>
            </div>
          </div>

          <div class="col-12">
            <p-divider></p-divider>
          </div>

          <!-- Risk Summary -->
          <div class="col-12">
            <div class="bg-gray-50 border-round p-4">
              <h4 class="text-900 font-semibold mb-3">
                <i class="pi pi-shield mr-2"></i>Kockázatkezelési Összefoglaló
              </h4>
              <div class="grid">
                <div class="col-12 md:col-4">
                  <div class="text-center p-3 border-round bg-white">
                    <div class="text-2xl font-bold text-blue-600">{{ riskConfig.max_daily_trades }}</div>
                    <div class="text-600">Max napi trade</div>
                  </div>
                </div>
                <div class="col-12 md:col-4">
                  <div class="text-center p-3 border-round bg-white">
                    <div class="text-2xl font-bold text-red-600">{{ riskConfig.daily_loss_limit }}%</div>
                    <div class="text-600">Max napi veszteség</div>
                  </div>
                </div>
                <div class="col-12 md:col-4">
                  <div class="text-center p-3 border-round bg-white">
                    <div class="text-2xl font-bold text-orange-600">{{ riskConfig.max_position_size }}%</div>
                    <div class="text-600">Max pozíció méret</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12">
            <p-divider></p-divider>
          </div>

          <div class="col-12">
            <div class="flex justify-content-end">
              <p-button 
                label="Mentés" 
                icon="pi pi-save" 
                [loading]="savingRisk"
                [disabled]="!isRiskConfigValid()"
                (onClick)="saveRiskManagementConfig()">
              </p-button>
            </div>
          </div>
        </div>
      </p-card>
    </p-tabPanel>

    <!-- Current Settings Tab -->
    <p-tabPanel header="Jelenlegi Beállítások" leftIcon="pi pi-eye">
      <div class="grid">
        <!-- Current Position Config -->
        <div class="col-12 lg:col-6">
          <p-card header="Pozíció Méret Konfiguráció" styleClass="h-full">
            <div *ngIf="currentPositionConfig; else noPositionConfig">
              <div class="flex align-items-center mb-3">
                <i class="pi pi-dollar text-blue-500 mr-2"></i>
                <strong>Mód:</strong> 
                <span class="ml-2">{{ currentPositionConfig.mode === 'percentage' ? 'Százalékos' : 'Fix USD' }}</span>
              </div>
              
              <div *ngIf="currentPositionConfig.mode === 'percentage'" class="mb-3">
                <div class="flex align-items-center">
                  <i class="pi pi-percentage text-green-500 mr-2"></i>
                  <strong>Maximum százalék:</strong> 
                  <span class="ml-2">{{ currentPositionConfig.max_percentage }}%</span>
                </div>
              </div>
              
              <div *ngIf="currentPositionConfig.mode === 'fixed_usd'" class="mb-3">
                <div class="flex align-items-center">
                  <i class="pi pi-dollar text-green-500 mr-2"></i>
                  <strong>Fix összeg:</strong> 
                  <span class="ml-2">${{ currentPositionConfig.fixed_amount_usd }}</span>
                </div>
              </div>
            </div>
            
            <ng-template #noPositionConfig>
              <div class="text-center text-600">
                <i class="pi pi-info-circle text-3xl mb-3"></i>
                <p>Nincs betöltött konfiguráció</p>
              </div>
            </ng-template>
          </p-card>
        </div>

        <!-- Current Risk Config -->
        <div class="col-12 lg:col-6">
          <p-card header="Kockázatkezelési Konfiguráció" styleClass="h-full">
            <div *ngIf="currentTradingConfig; else noTradingConfig">
              <div class="flex align-items-center mb-3">
                <i class="pi pi-calendar text-blue-500 mr-2"></i>
                <strong>Max napi trade:</strong> 
                <span class="ml-2">{{ currentTradingConfig.max_daily_trades }}</span>
              </div>
              
              <div class="flex align-items-center mb-3">
                <i class="pi pi-exclamation-triangle text-red-500 mr-2"></i>
                <strong>Napi veszteség limit:</strong> 
                <span class="ml-2">{{ (currentTradingConfig.daily_loss_limit * 100) | number:'1.1-1' }}%</span>
              </div>
              
              <div class="flex align-items-center mb-3">
                <i class="pi pi-chart-pie text-orange-500 mr-2"></i>
                <strong>Max pozíció méret:</strong> 
                <span class="ml-2">{{ (currentTradingConfig.max_position_size * 100) | number:'1.1-1' }}%</span>
              </div>
            </div>
            
            <ng-template #noTradingConfig>
              <div class="text-center text-600">
                <i class="pi pi-info-circle text-3xl mb-3"></i>
                <p>Nincs betöltött konfiguráció</p>
              </div>
            </ng-template>
          </p-card>
        </div>

        <!-- Wallet Info -->
        <div class="col-12" *ngIf="walletBalance">
          <p-card header="Portfólió Információ">
            <div class="grid">
              <div class="col-12 md:col-3">
                <div class="text-center p-3 border-round bg-blue-50">
                  <div class="text-2xl font-bold text-blue-600">${{ walletBalance | number:'1.2-2' }}</div>
                  <div class="text-600">Teljes egyenleg</div>
                </div>
              </div>
              <div class="col-12 md:col-3" *ngIf="currentPositionConfig?.mode === 'percentage'">
                <div class="text-center p-3 border-round bg-green-50">
                  <div class="text-2xl font-bold text-green-600">${{ calculateExampleAmount() | number:'1.2-2' }}</div>
                  <div class="text-600">Pozíció méret</div>
                </div>
              </div>
              <div class="col-12 md:col-3" *ngIf="currentTradingConfig">
                <div class="text-center p-3 border-round bg-red-50">
                  <div class="text-2xl font-bold text-red-600">${{ calculateDailyLossAmount() | number:'1.2-2' }}</div>
                  <div class="text-600">Max napi veszteség</div>
                </div>
              </div>
              <div class="col-12 md:col-3" *ngIf="currentTradingConfig">
                <div class="text-center p-3 border-round bg-orange-50">
                  <div class="text-2xl font-bold text-orange-600">${{ calculateMaxPositionAmount() | number:'1.2-2' }}</div>
                  <div class="text-600">Max pozíció</div>
                </div>
              </div>
            </div>
          </p-card>
        </div>

        <!-- Refresh Button -->
        <div class="col-12">
          <div class="flex justify-content-center">
            <p-button 
              label="Beállítások Frissítése" 
              icon="pi pi-refresh" 
              severity="secondary"
              [loading]="loadingPosition || loadingRisk"
              (onClick)="loadAllConfigs()">
            </p-button>
          </div>
        </div>
      </div>
    </p-tabPanel>
  </p-tabView>
</div>

<p-toast></p-toast>